<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <parent>
        <groupId>net.disy.iam.keycloak</groupId>
        <artifactId>disy-keycloak</artifactId>
        <version>${revision}.${changelist}</version>
        <relativePath>../pom.xml</relativePath>
    </parent>

    <artifactId>dist</artifactId>
    <packaging>jar</packaging>

    <properties>
        <version.quarkus>2.13.8.Final</version.quarkus> <!-- ensure quarkus version is compatible with keycloak -->
        <version.agroal>1.17</version.agroal>
        <version.saaj>1.4.1.SP1</version.saaj>
        <version.infinispan>14.0.7.Final</version.infinispan>
        <version.statex>1.8.3</version.statex>
        <version.asm>9.4</version.asm>
        <version.okhttp>4.10.0</version.okhttp>
        <version.jakarta.servlet.jakarta-servlet-api>6.0.0</version.jakarta.servlet.jakarta-servlet-api>
        <version.brotli4j>1.8.0</version.brotli4j>
        <version.jackson>2.13.4</version.jackson>
        <version.jakarta.activation>1.2.2</version.jakarta.activation>

        <!-- Plugins -->
        <version.git-commit-id-plugin>4.9.10</version.git-commit-id-plugin>
        <version.docker-maven-plugin>0.38.0</version.docker-maven-plugin>
        <version.maven-resources-plugin>3.2.0</version.maven-resources-plugin>

        <!-- Quarkus -->
        <quarkus.application.name>company-dist</quarkus.application.name>
        <!--quarkus.native.builder-image>mutable-jar</quarkus.native.builder-image-->
        <quarkus.native.builder-image>quay.io/quarkus/ubi-quarkus-mandrel-builder-image:22.3-java17</quarkus.native.builder-image>
        <quarkus.package.type>native</quarkus.package.type>
    </properties>

    <dependencies>

        <dependency>
            <!-- Base Keycloak Distribution -->
            <groupId>org.keycloak</groupId>
            <artifactId>keycloak-quarkus-dist</artifactId>
            <version>${version.keycloak}</version>
            <type>zip</type>
            <exclusions>
                <!-- prevents org.keycloak.keycloak-quarkus-server-app.jar
                     to be in lib/main
                     -->
                <exclusion>
                    <groupId>org.keycloak</groupId>
                    <artifactId>keycloak-quarkus-server-app</artifactId>
                </exclusion>
            </exclusions>
        </dependency>

        <dependency>
            <!-- Keycloak Quarkus Server Libraries-->
            <groupId>org.keycloak</groupId>
            <artifactId>keycloak-quarkus-server</artifactId>
            <version>${version.keycloak}</version>

            <exclusions>
                <!-- Exclude unused dependencies -->

                <exclusion>
                    <!-- CVE_MITIGATION: CVE-2020-36518 excluded since this includes an outdated version of jackson-databind that is affected by a CVE.-->
                    <groupId>org.wildfly.security</groupId>
                    <artifactId>wildfly-elytron</artifactId>
                </exclusion>
                <exclusion>
                    <groupId>org.jboss.spec.javax.xml.bind</groupId>
                    <artifactId>jboss-jaxb-api_2.3_spec</artifactId>
                </exclusion>

                <!-- Exclude unused support for: PostgresSQL -->
                <!--                <exclusion>-->
                <!--                    <groupId>org.postgresql</groupId>-->
                <!--                    <artifactId>postgresql</artifactId>-->
                <!--                </exclusion>-->
                <!--                <exclusion>-->
                <!--                    <groupId>io.quarkus</groupId>-->
                <!--                    <artifactId>quarkus-jdbc-postgresql</artifactId>-->
                <!--                </exclusion>-->
                <!--                <exclusion>-->
                <!--                    <groupId>io.quarkus</groupId>-->
                <!--                    <artifactId>quarkus-jdbc-postgresql-deployment</artifactId>-->
                <!--                </exclusion>-->

                <!-- Exclude unused support for: MySQL -->
                <exclusion>
                    <groupId>mysql</groupId>
                    <artifactId>mysql-connector-java</artifactId>
                </exclusion>
                <exclusion>
                    <groupId>io.quarkus</groupId>
                    <artifactId>quarkus-jdbc-mysql</artifactId>
                </exclusion>
                <exclusion>
                    <groupId>io.quarkus</groupId>
                    <artifactId>quarkus-jdbc-mysql-deployment</artifactId>
                </exclusion>

                <!-- Exclude unused support for: MSSQL -->
                <exclusion>
                    <groupId>com.microsoft.sqlserver</groupId>
                    <artifactId>mssql-jdbc</artifactId>
                </exclusion>
                <exclusion>
                    <groupId>io.quarkus</groupId>
                    <artifactId>quarkus-jdbc-mssql</artifactId>
                </exclusion>
                <exclusion>
                    <groupId>io.quarkus</groupId>
                    <artifactId>quarkus-jdbc-mssql-deployment</artifactId>
                </exclusion>

                <!-- Exclude unused support for: Oracle -->
                <exclusion>
                    <groupId>com.oracle.database.jdbc</groupId>
                    <artifactId>ojdbc11</artifactId>
                </exclusion>
                <exclusion>
                    <groupId>io.quarkus</groupId>
                    <artifactId>quarkus-jdbc-oracle</artifactId>
                </exclusion>
                <exclusion>
                    <groupId>io.quarkus</groupId>
                    <artifactId>quarkus-jdbc-oracle-deployment</artifactId>
                </exclusion>

                <!-- Exclude unused support for: MariaDB -->
                <exclusion>
                    <groupId>org.mariadb.jdbc</groupId>
                    <artifactId>mariadb-java-client</artifactId>
                </exclusion>
                <exclusion>
                    <groupId>io.quarkus</groupId>
                    <artifactId>quarkus-jdbc-mariadb</artifactId>
                </exclusion>
                <exclusion>
                    <groupId>io.quarkus</groupId>
                    <artifactId>quarkus-jdbc-mariadb-deployment</artifactId>
                </exclusion>

                <!-- Exclude unused support for: H2 -->
                <!-- Note: by default keycloak uses the h2 database as database for auto-build.
                     To remove h2, one needs to configure another Database in src/main/resources/META-INF/keycloak.conf -->
               <exclusion>
                    <groupId>com.h2database</groupId>
                    <artifactId>h2</artifactId>
                </exclusion>
                <exclusion>
                    <groupId>io.quarkus</groupId>
                    <artifactId>quarkus-jdbc-h2</artifactId>
                </exclusion>
                <exclusion>
                    <groupId>io.quarkus</groupId>
                    <artifactId>quarkus-jdbc-h2-deployment</artifactId>
                </exclusion>

            </exclusions>


        </dependency>


        <!-- just like the keycloak build itself: prevents
         - org.keycloak.keycloak-admin-cli
         - org.keycloak.keycloak-client-registration-cli
         to be in lib/main
         -->
        <dependency>
            <groupId>org.keycloak</groupId>
            <artifactId>keycloak-client-cli-dist</artifactId>
            <version>${version.keycloak}</version>
            <type>zip</type>
            <exclusions>
                <exclusion>
                    <groupId>*</groupId>
                    <artifactId>*</artifactId>
                </exclusion>
            </exclusions>
        </dependency>

        <!-- Additional Quarkus Features: Begin -->
        <!-- Additional Quarkus Features: End -->
    </dependencies>

    <dependencyManagement>

        <dependencies>

            <!-- fixed all quarkus dependencies, but breaks build without keycloak common -->
            <dependency>
                <!-- use dependencies from quarkus bom -->
                <groupId>io.quarkus.platform</groupId>
                <artifactId>quarkus-bom</artifactId>
                <version>${version.quarkus}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>

            <!-- fixes build when using quarkus bom -->
            <dependency>
                <!-- pull up to match version used by Keycloak -->
                <groupId>org.keycloak</groupId>
                <artifactId>keycloak-common</artifactId>
                <version>${version.keycloak}</version>
            </dependency>

            <!-- fixes 19.0.1 dependency of keycloak-quarkus-server -->
            <dependency>
                <groupId>org.keycloak</groupId>
                <artifactId>keycloak-core</artifactId>
                <version>${version.keycloak}</version>
            </dependency>

            <!-- no downgrades -->

            <dependency>
                <groupId>com.squareup.okhttp3</groupId>
                <artifactId>okhttp</artifactId>
                <version>${version.okhttp}</version>
            </dependency>

            <dependency>
                <groupId>org.ow2.asm</groupId>
                <artifactId>asm</artifactId>
                <version>${version.asm}</version>
            </dependency>
            <dependency>
                <groupId>org.ow2.asm</groupId>
                <artifactId>asm-commons</artifactId>
                <version>${version.asm}</version>
            </dependency>
            <dependency>
                <groupId>org.ow2.asm</groupId>
                <artifactId>asm-util</artifactId>
                <version>${version.asm}</version>
            </dependency>
            <dependency>
                <groupId>org.ow2.asm</groupId>
                <artifactId>asm-tree</artifactId>
                <version>${version.asm}</version>
            </dependency>

            <!-- Override the dependencies below to use the versions used by Keycloak -->
            <dependency>
                <groupId>org.infinispan</groupId>
                <artifactId>infinispan-core</artifactId>
                <version>${version.infinispan}</version>
            </dependency>
            <dependency>
                <groupId>org.infinispan</groupId>
                <artifactId>infinispan-commons</artifactId>
                <version>${version.infinispan}</version>
            </dependency>
            <dependency>
                <groupId>org.infinispan</groupId>
                <artifactId>infinispan-server-hotrod</artifactId>
                <version>${version.infinispan}</version>
            </dependency>
            <dependency>
                <groupId>org.infinispan</groupId>
                <artifactId>infinispan-client-hotrod</artifactId>
                <version>${version.infinispan}</version>
            </dependency>
            <dependency>
                <groupId>org.infinispan</groupId>
                <artifactId>infinispan-query-dsl</artifactId>
                <version>${version.infinispan}</version>
            </dependency>
            <dependency>
                <groupId>org.infinispan</groupId>
                <artifactId>infinispan-remote-query-client</artifactId>
                <version>${version.infinispan}</version>
            </dependency>

            <dependency>
                <groupId>io.agroal</groupId>
                <artifactId>agroal-api</artifactId>
                <version>${version.agroal}</version>
            </dependency>
            <dependency>
                <groupId>io.agroal</groupId>
                <artifactId>agroal-narayana</artifactId>
                <version>${version.agroal}</version>
            </dependency>
            <dependency>
                <groupId>io.agroal</groupId>
                <artifactId>agroal-pool</artifactId>
                <version>${version.agroal}</version>
            </dependency>


            <!-- Dependencies removed from JDK 11 and in compliance with those used by Wildfly. -->
            <dependency>
                <groupId>com.sun.xml.messaging.saaj</groupId>
                <artifactId>saaj-impl</artifactId>
                <version>${version.saaj}</version>
                <exclusions>
                    <exclusion>
                        <groupId>javax.xml.soap</groupId>
                        <artifactId>saaj-api</artifactId>
                    </exclusion>
                    <exclusion>
                        <groupId>org.jvnet.mimepull</groupId>
                        <artifactId>mimepull</artifactId>
                    </exclusion>
                    <exclusion>
                        <groupId>org.jvnet.staxex</groupId>
                        <artifactId>stax-ex</artifactId>
                    </exclusion>
                </exclusions>
            </dependency>
            <dependency>
                <groupId>org.jvnet.staxex</groupId>
                <artifactId>stax-ex</artifactId>
                <version>${version.statex}</version>
                <exclusions>
                    <exclusion>
                        <groupId>javax.xml.stream</groupId>
                        <artifactId>stax-api</artifactId>
                    </exclusion>
                    <exclusion>
                        <groupId>javax.activation</groupId>
                        <artifactId>activation</artifactId>
                    </exclusion>
                </exclusions>
            </dependency>

            <dependency>
                <groupId>com.aayushatharva.brotli4j</groupId>
                <artifactId>brotli4j</artifactId>
                <version>${version.brotli4j}</version>
            </dependency>
            <dependency>
                <groupId>com.aayushatharva.brotli4j</groupId>
                <artifactId>native-linux-x86_64</artifactId>
                <version>${version.brotli4j}</version>
            </dependency>
            <dependency>
                <groupId>com.fasterxml.jackson.core</groupId>
                <artifactId>jackson-annotations</artifactId>
                <version>${version.jackson}</version>
            </dependency>
            <dependency>
                <groupId>com.fasterxml.jackson.core</groupId>
                <artifactId>jackson-core</artifactId>
                <version>${version.jackson}</version>
            </dependency>
            <dependency>
                <groupId>com.fasterxml.jackson.jaxrs</groupId>
                <artifactId>jackson-jaxrs-base</artifactId>
                <version>${version.jackson}</version>
            </dependency>
            <dependency>
                <groupId>com.fasterxml.jackson.jaxrs</groupId>
                <artifactId>jackson-jaxrs-json-provider</artifactId>
                <version>${version.jackson}</version>
            </dependency>
            <dependency>
                <groupId>com.fasterxml.jackson.module</groupId>
                <artifactId>jackson-module-jaxb-annotations</artifactId>
                <version>${version.jackson}</version>
            </dependency>
            <dependency>
                <groupId>com.sun.activation</groupId>
                <artifactId>jakarta.activation</artifactId>
                <version>${version.jakarta.activation}</version>
            </dependency>

            <dependency>
                <groupId>jakarta.servlet</groupId>
                <artifactId>jakarta.servlet-api</artifactId>
                <version>${version.jakarta.servlet.jakarta-servlet-api}</version>
            </dependency>


        </dependencies>
        
        
    </dependencyManagement>

    <build>
        <finalName>company-keycloak-${project.version}</finalName>

        <plugins>

            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-dependency-plugin</artifactId>
                <executions>
                    <execution>
                        <id>unpack-keycloak-server-distribution</id>
                        <phase>package</phase>
                        <goals>
                            <goal>unpack</goal>
                        </goals>
                        <configuration>
                            <artifactItems>
                                <artifactItem>
                                    <groupId>org.keycloak</groupId>
                                    <artifactId>keycloak-quarkus-dist</artifactId>
                                    <type>zip</type>
                                    <outputDirectory>target</outputDirectory>
                                </artifactItem>
                            </artifactItems>
                            <excludes>**/lib/**</excludes>
                            <!-- We could also remove the unused admin-client libraries ,**/bin/client/**-->
                            <excludes>**/bin/client/**</excludes>
                        </configuration>
                    </execution>

<!--                    <execution>
                        <id>add-extensions</id>
                        <goals>
                            <goal>copy</goal>
                        </goals>
                        <configuration>
                            <artifactItems>
                                <artifactItem>
                                    <groupId>${project.groupId}</groupId>
                                    <artifactId>extensions</artifactId>
                                    <version>${revision}.${changelist}</version>
                                    <type>jar</type>
                                    <destFileName>extensions.jar</destFileName>
                                    <outputDirectory>${project.build.directory}/keycloak-${version.keycloak}/providers
                                    </outputDirectory>
                                </artifactItem>
                            </artifactItems>
                        </configuration>
                    </execution>
                  -->
                </executions>
            </plugin>

            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-resources-plugin</artifactId>
                <version>${version.maven-resources-plugin}</version>
                <!-- copy the setup files to the keycloak dist folder -->
                <executions>
                    <execution>
                        <id>add-additional-keycloak-resources</id>
                        <phase>package</phase>
                        <goals>
                            <goal>copy-resources</goal>
                        </goals>
                        <configuration>
                            <outputDirectory>${project.build.directory}/keycloak-${version.keycloak}</outputDirectory>
                            <overwrite>true</overwrite>
                            <resources>
                                <resource>
                                    <directory>${project.basedir}/src/main/copy-to-keycloak</directory>
                                    <filtering>false</filtering>
                                </resource>
                            </resources>
                        </configuration>
                    </execution>

                    <execution>
                        <id>add-themes</id>
                        <phase>package</phase>
                        <goals>
                            <goal>copy-resources</goal>
                        </goals>
                        <configuration>
                            <outputDirectory>${project.build.directory}/keycloak-${version.keycloak}/themes</outputDirectory>
                            <overwrite>true</overwrite>
                            <resources>
                                <resource>
                                    <directory>${project.basedir}/../themes</directory>
                                    <filtering>false</filtering>
                                </resource>
                            </resources>
                        </configuration>
                    </execution>
                </executions>
            </plugin>

            <plugin>
                <groupId>io.quarkus</groupId>
                <artifactId>quarkus-maven-plugin</artifactId>
                <version>${version.quarkus}</version>
                <configuration>
                    <finalName>keycloak</finalName>
                    <buildDir>${project.build.directory}/keycloak-${version.keycloak}</buildDir>
                </configuration>
                <executions>
                    <execution>
                        <goals>
                            <goal>build</goal>
                        </goals>
                    </execution>
                </executions>
            </plugin>

            <plugin>
                <groupId>pl.project13.maven</groupId>
                <artifactId>git-commit-id-plugin</artifactId>
                <version>${version.git-commit-id-plugin}</version>

                <executions>
                    <execution>
                        <id>git-commit-id-on-validate-revision</id>
                        <phase>validate</phase>
                        <goals>
                            <goal>revision</goal>
                        </goals>
                    </execution>
                </executions>

                <configuration>
                    <skipPoms>false</skipPoms>
                    <generateGitPropertiesFile>true</generateGitPropertiesFile>
                    <!-- enables other plugins to use git properties -->
                    <injectAllReactorProjects>true</injectAllReactorProjects>
                </configuration>
            </plugin>

            <plugin>
                <groupId>io.fabric8</groupId>
                <artifactId>docker-maven-plugin</artifactId>
                <version>${version.docker-maven-plugin}</version>
                <executions>
                    <execution>
                        <id>docker-build-100</id>
                        <phase>docker</phase>
                        <goals>
                            <goal>build</goal>
                        </goals>
                    </execution>
                </executions>

                <configuration>
                    <verbose>true</verbose>
                    <logStdout>true</logStdout>

                    <images>
                        <image>
                            <name>${docker.image}</name>
                            <build>
                                <tags>
                                    <tag>${project.version}</tag>
                                    <tag>${git.commit.id}</tag>
                                </tags>

                                <!-- src/main/docker/keycloak/Dockerfile -->
                                <dockerFile>${docker.file}</dockerFile>

                                <assembly>
                                    <inline>
                                        <fileSet>
                                            <directory>${project.build.directory}/keycloak-${version.keycloak}
                                            </directory>
                                            <outputDirectory>keycloak</outputDirectory>
                                        </fileSet>
                                    </inline>
                                </assembly>
                            </build>
                        </image>
                    </images>
                </configuration>
            </plugin>
        </plugins>
    </build>

</project>
